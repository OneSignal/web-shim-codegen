#!/bin/bash

set -euo pipefail

echo "Linting..."
yarn run lint
echo 'Done.'

echo "Cleanup..."
rm -rf build
rm -rf ts-to-es6
echo 'Done.'

mkdir -p dist/vue

echo "Transpiling..."
tsc
echo 'Done.'

echo "Code-generation initiating..."
yellicode
echo 'Done.'

echo 'Bundling Angular SDK...'
cd src/scaffolds/angular-workspace
yarn && yarn build --configuration production
cp -R dist/onesignal-ngx ../../../build
cd ../../../
echo 'Done.'

echo 'Copying static files...'
./scripts/copy-static
echo 'Done.'

echo 'Downstream repos setup.'
cd build
echo 'Archiving...'
tar cvfz onesignal-ngx.tgz onesignal-ngx
tar cvfz react.tgz react
tar cvfz vue2.tgz vue2
tar cvfz vue3.tgz vue3
echo 'Done.'
cd ..

echo 'Moving build files...'
mv build/onesignal-ngx.tgz dist/onesignal-ngx.tgz
mv build/react.tgz dist/react.tgz
mv build/vue2.tgz dist/vue2.tgz
mv build/vue3.tgz dist/vue3.tgz
echo 'Done.'

echo 'Diff between current build and the content of the downstream repo.'
git diff --diff-filter=RD --name-status --no-index outputs/onesignal-ngx build/onesignal-ngx | cut -f 2 | perl -pe 's{outputs/[^/]+/}{}' >> build/onesignal-ngx.rmfiles  || true
git diff --diff-filter=RD --name-status --no-index outputs/react build/react | cut -f 2 | perl -pe 's{outputs/[^/]+/}{}' >> build/react.rmfiles || true
git diff --diff-filter=RD --name-status --no-index outputs/vue2 build/vue/v2 | cut -f 2 | perl -pe 's{outputs/[^/]+/}{}' >> build/vue2.rmfiles  || true
git diff --diff-filter=RD --name-status --no-index outputs/vue3 build/vue/v3 | cut -f 2 | perl -pe 's{outputs/[^/]+/}{}' >> build/vue3.rmfiles  || true
echo 'Done.'
