name: 'Create Pull Request'
description: 'Creates a pull request for syncing with web-shim-codegen'

inputs:
  owner:
    description: 'Repository owner'
    required: true
  repo:
    description: 'Repository name'
    required: true
  package_version:
    description: 'Package version to include in PR title'
    required: true
  base:
    description: 'Base branch for the PR'
    required: false
    default: 'main'
  head:
    description: 'Head branch for the PR'
    required: false
    default: 'cd_update'
  github_token:
    description: 'GitHub token for authentication'
    required: true

runs:
  using: 'composite'
  steps:
    - name: Create or Update Pull Request
      uses: actions/github-script@v7
      continue-on-error: true
      with:
        github-token: ${{ inputs.github_token }}
        script: |
          const title = 'build: sync with web-shim-codegen v' + '${{ inputs.package_version }}';
          const body = 'This update was generated by the GitHub CD action.';

          // Check if a PR already exists for this branch
          const existingPRs = await github.rest.pulls.list({
            owner: '${{ inputs.owner }}',
            repo: '${{ inputs.repo }}',
            head: '${{ inputs.owner }}:${{ inputs.head }}',
            base: '${{ inputs.base }}',
            state: 'open'
          });

          if (existingPRs.data.length > 0) {
            // Update existing PR
            const pr = existingPRs.data[0];
            await github.rest.pulls.update({
              owner: '${{ inputs.owner }}',
              repo: '${{ inputs.repo }}',
              pull_number: pr.number,
              title: title,
              body: body
            });
            console.log(`Updated existing PR #${pr.number}`);
          } else {
            // Create new PR
            const pr = await github.rest.pulls.create({
              owner: '${{ inputs.owner }}',
              repo: '${{ inputs.repo }}',
              title: title,
              body: body,
              base: '${{ inputs.base }}',
              head: '${{ inputs.head }}'
            });
            console.log(`Created new PR #${pr.data.number}`);
          }
